name: Smart File Sync with Path Encoding
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

# ================= ç”¨æˆ·é…ç½®åŒº =================
env:
  URL_LIST_FILE: 'rule-list.txt'     # URLåˆ—è¡¨æ–‡ä»¶
  TARGET_BASE_DIR: 'rules' # å­˜å‚¨ç›®å½•
  PATH_SEGMENTS: 2                 # ä½¿ç”¨æœ€åNæ®µè·¯å¾„ä½œä¸ºç‰¹å¾ç  (æ¨è2)
# ==============================================

permissions:
  contents: write

jobs:
  file-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare workspace
        run: |
          mkdir -p "${{ env.TARGET_BASE_DIR }}"
          rm -rf ./sync-logs && mkdir ./sync-logs

      - name: Download files
        run: |
          while IFS= read -r raw_url; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && continue
            
            # æ¸…æ´—URLå¹¶æå–è·¯å¾„
            url="${raw_url%%[#?]*}"
            path_parts=($(echo "$url" | awk -F/ '{for(i=1;i<=NF;i++) if($i!="") print $i}'))
            
            # ç”Ÿæˆè·¯å¾„ç‰¹å¾ç 
            if [ ${#path_parts[@]} -ge ${{ env.PATH_SEGMENTS} } ]; then
              start_idx=$(( ${#path_parts[@]} - ${{ env.PATH_SEGMENTS} } ))
              signature=$(IFS=_ ; echo "${path_parts[*]:$start_idx:${{ env.PATH_SEGMENTS} }}")
            else
              signature="${path_parts[-1]}"
            fi

            # æ„å»ºå®‰å…¨æ–‡ä»¶å
            original_name="${url##*/}"
            safe_name="${signature}_${original_name}"
            safe_name="${safe_name//[^a-zA-Z0-9_.-]/_}"  # æ›¿æ¢éæ³•å­—ç¬¦
            
            # æ‰§è¡Œä¸‹è½½
            output_path="${{ env.TARGET_BASE_DIR }}/$safe_name"
            echo "ä¸‹è½½: $url â†’ $output_path"
            
            if curl -fL "$url" -o "$output_path"; then
              echo "[SUCCESS] $(date +%FT%T) $url" >> ./sync-logs/success.log
            else
              echo "[FAILED] $(date +%FT%T) $url" >> ./sync-logs/error.log
              exit 1
            fi
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit changes
        if: success()
        run: |
          git config --global user.name "Auto Syncer"
          git config --global user.email "auto-sync@github"
          
          git add "${{ env.TARGET_BASE_DIR }}"
          if ! git diff --quiet --exit-code; then
            git commit -m "ğŸ”„ Synced files: $(date +%F)"
            git push
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v3
        with:
          name: sync-logs
          path: ./sync-logs

  status-notify:
    needs: [file-sync]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions-cool/workflow-status@v1
        with:
          check: ${{ needs.file-sync.result }}
          success: 'âœ… æˆåŠŸåŒæ­¥åˆ°ç›®å½•: ${{ env.TARGET_BASE_DIR }}'
          failure: 'âŒ åŒæ­¥å¤±è´¥ï¼Œä¸‹è½½æ—¥å¿—æŸ¥çœ‹è¯¦æƒ…'
