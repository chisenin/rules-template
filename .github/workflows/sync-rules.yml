name: Sync Rules

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: '0 4 * * *' # 每天 4:00 自动触发
  push:
    paths:
      - rules-list.txt # 当 rules-list.txt 文件变动时触发

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Read rules-list.txt
        id: read_rules
        run: |
          # 读取规则列表并生成下载命令
          echo "url_list=$(cat rules-list.txt | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Download files
        run: |
          IFS=' ' read -r -a urls <<< "$url_list"
          for url in "${urls[@]}"; do
            # 提取文件名和路径
            filename=$(basename "$url")
            path=$(dirname "$url")
            # 提取最后一段路径名
            last_segment=$(basename "$path")
            # 新文件名
            new_filename="${last_segment}_${filename}"
            # 下载文件
            if curl -L -o "rules/$new_filename" "$url"; then
              echo "Downloaded: $new_filename"
            else
              echo "Failed to download: $url" >> download_errors.log
            fi
          done

      - name: Check for updates
        run: |
          # 检查是否有新文件下载
          if [ -s download_errors.log ]; then
            echo "Some files failed to download. Check download_errors.log for details."
          else
            echo "All files downloaded successfully."
          fi
