name: Sync Rules Files

on:
  push:
    paths:
      - rules-list.txt
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

env:
  RULES_LIST: rules-list.txt
  OUTPUT_DIR: rules
  CSV_FILE: mapping.csv

jobs:
  sync-rules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create output directory if not exists
      run: mkdir -p ${{ env.OUTPUT_DIR }}

    - name: Verify rules-list.txt exists
      run: |
        if [ ! -f "${{ env.RULES_LIST }}" ]; then
          echo "Error: ${RULES_LIST} file does not exist."
          exit 1
        fi

    - name: Print contents of rules-list.txt
      run: cat "${{ env.RULES_LIST }}"

    - name: Generate CSV mapping list
      id: generate_csv_mapping
      run: |
        > "${{ env.CSV_FILE }}"
        echo "URL,Final_Filename" >> "${{ env.CSV_FILE }}"
        declare -A seen_filenames
        while IFS= read -r url; do
          # Skip empty lines or comments
          if [[ -z "$url" || "$url" == \#* ]]; then
            continue
          fi

          # Ensure the URL has the correct protocol
          if [[ ! "$url" =~ ^https?:// ]]; then
            echo "Invalid URL: $url. URLs must start with http:// or https://"
            continue
          fi

          # Extract the last path segment from URL
          last_segment=$(basename "$(dirname "$url")")
          filename=$(basename "$url")

          # Determine the final filename to use
          final_filename="$filename"
          counter=1

          # Check if the filename has been seen before
          if [[ -n "${seen_filenames[$filename]}" ]]; then
            # If a file with the same name exists, rename both the existing and new file
            extension="${filename##*.}"
            base="${filename%.*}"
            unique_base="$base-$last_segment"

            # Rename existing files
            for existing_file in "${{ env.OUTPUT_DIR }}/$base"*"$extension"; do
              if [ -f "$existing_file" ]; then
                new_existing_filename="${unique_base}-${counter}.${extension}"
                mv "$existing_file" "${{ env.OUTPUT_DIR }}/$new_existing_filename"
                echo "Renamed existing file: $(basename "$existing_file") -> $new_existing_filename"
                ((counter++))
              fi
            done

            # Set the new final filename
            final_filename="${unique_base}-${counter}.${extension}"
            echo "File $filename already exists. Renaming to $final_filename."
            ((counter++))
          else
            # Mark the filename as seen
            seen_filenames[$filename]=1
          fi

          # Add entry to CSV mapping file
          echo "$url,$final_filename" >> "${{ env.CSV_FILE }}"
        done < "${{ env.RULES_LIST }}"

    - name: Print CSV mapping list
      run: cat "${{ env.CSV_FILE }}"

    - name: Print URLs to be downloaded
      id: print_urls
      run: |
        echo "URLs to be downloaded:"
        tail -n +2 "${{ env.CSV_FILE }}" | while IFS=',' read -r url final_filename; do
          echo "URL: $url -> Final Filename: $final_filename"
        done

    - name: Download files based on CSV mapping list
      id: download_files
      run: |
        > temp_mapping.csv
        echo "URL,Final_Filename" >> temp_mapping.csv
        tail -n +2 "${{ env.CSV_FILE }}" | while IFS=',' read -r url final_filename; do
          local_file="${{ env.OUTPUT_DIR }}/${final_filename}"

          # Check if the file already exists and is up to date
          if [ -f "$local_file" ]; then
            echo "Checking if $final_filename needs updating..."
            current_hash=$(sha256sum "$local_file" | awk '{print $1}')
            new_hash=$(wget --spider --server-response "$url" 2>&1 | grep ETag | awk '{print $2}' | tr -d '"')
            
            if [ "$current_hash" == "$new_hash" ]; then
              echo "$final_filename is already up to date. Skipping download."
              continue
            fi
          fi

          echo "Downloading $url as $final_filename"
          wget --continue -O "$local_file" "$url" || echo "Failed to download $url"
          # Add to temp_mapping.csv for retention
          echo "$url,$final_filename" >> temp_mapping.csv
        done

        # Move temp_mapping.csv to CSV_FILE
        mv temp_mapping.csv "${{ env.CSV_FILE }}"

    - name: List files in rules directory
      run: ls -la "${{ env.OUTPUT_DIR }}"

    - name: Add changes to staging
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add "${{ env.OUTPUT_DIR }}"
        git add "${{ env.CSV_FILE }}"

    - name: Commit changes
      run: |
        git diff-index --quiet HEAD || git commit -m "Update rules files from rules-list.txt"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
