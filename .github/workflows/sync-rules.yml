name: Sync Rules

on:
  # 手动触发
  workflow_dispatch:
  # 每天凌晨4点自动触发
  schedule:
    - cron: '0 4 * * *'
  # rules-list.txt文件变动时触发
  push:
    paths:
      - 'rules-list.txt'

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Read rules-list.txt
        id: read-list
        run: |
          echo "READING RULES LIST"
          while IFS= read -r line; do
            rules_list+=("$line")
          done < rules-list.txt
          echo "RULES LIST: ${rules_list[*]}"
          echo "NUMBER OF RULES: ${#rules_list[@]}"

      - name: Download and rename files
        id: download-files
        run: |
          echo "DOWNLOADING AND RENAMING FILES"
          for i in "${!rules_list[@]}"; do
            url=$(echo "${rules_list[$i]}" | cut -d "/" -f 8-)
            filename=$(basename "${rules_list[$i]}")
            dirname=$(dirname "${rules_list[$i]}")
            new_filename=$(echo "${dirname##*/}_${filename}" | sed 's/\.srs/-srs/')
            curl -o "rules/${new_filename}" "${rules_list[$i]}"
          done
