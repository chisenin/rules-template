name: Path-Correct Rules Sync
on:
  workflow_dispatch:
  push:
    paths:
      - 'rules-list.txt'
  schedule:
    - cron: '0 4 * * *'

env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_DIR: 'rules'
  PATH_SEGMENTS: 2

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Verify workspace
        run: |
          echo "GitHub工作空间: ${{ github.workspace }}"
          echo "仓库物理路径: ${{ github.workspace }}/repo"
          ls -la "${{ github.workspace }}/repo"

      - name: Create target directory
        run: |
          mkdir -p "${{ github.workspace }}/repo/${{ env.TARGET_DIR }}"
          echo "目录结构验证："
          tree -d "${{ github.workspace }}/repo"

      - name: Process URLs
        working-directory: ${{ github.workspace }}/repo
        run: |
          # 调试信息
          echo "当前工作目录: $(pwd)"
          echo "目标目录绝对路径: $(pwd)/${{ env.TARGET_DIR }}"

          while IFS= read -r raw_url; do
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && continue

            # 文件名生成逻辑...
            output_path="${{ env.TARGET_DIR }}/$safe_name"

            # 带路径验证的下载
            echo "下载到: $output_path"
            if curl -fL "$clean_url" -o "$output_path"; then
              echo "文件位置验证:"
              ls -l "$output_path"
            fi
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit changes
        working-directory: ${{ github.workspace }}/repo
        run: |
          echo "提交前工作目录: $(pwd)"
          git status
          git add "${{ env.TARGET_DIR }}"
          git commit -m "Update rules"
          git push
