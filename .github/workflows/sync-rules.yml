name: Auto File Sync with Debugging
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_BASE_DIR: 'rules'
  PATH_SEGMENTS: 2

permissions:
  contents: write

jobs:
  file-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show environment info
        run: |
          echo "::group::ğŸ› ï¸ ç¯å¢ƒé…ç½®"
          echo "URLåˆ—è¡¨æ–‡ä»¶: ${{ env.URL_LIST_FILE }}"
          echo "å­˜å‚¨ç›®å½•: ${{ env.TARGET_BASE_DIR }}"
          echo "è·¯å¾„æ·±åº¦: ${{ env.PATH_SEGMENTS }}"
          echo "::endgroup::"

      - name: Validate URL list
        run: |
          if [ ! -f "${{ env.URL_LIST_FILE }}" ]; then
            echo "::error::URLåˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨: ${{ env.URL_LIST_FILE }}"
            exit 1
          fi
          echo "æ‰¾åˆ° $(wc -l < "${{ env.URL_LIST_FILE }}") ä¸ªå¾…å¤„ç†URL"

      - name: Process URLs
        run: |
          mkdir -p "${{ env.TARGET_BASE_DIR }}"
          total=0
          success=0
          failure=0

          while IFS= read -r raw_url; do
            ((total++))
            
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && { 
              echo "è·³è¿‡æ³¨é‡Š/ç©ºè¡Œ: $raw_url"
              continue 
            }

            # è°ƒè¯•è¾“å‡ºåŸå§‹URL
            echo "::group::ğŸ” å¤„ç†URL #$total"
            echo "åŸå§‹URL: $raw_url"

            # æ¸…æ´—URL
            url="${raw_url%%[#?]*}"
            echo "æ¸…æ´—åURL: $url"

            # åˆ†ç¦»è·¯å¾„å’Œæ–‡ä»¶å
            original_name="${url##*/}"
            url_path="${url%/*}"
            echo "æ–‡ä»¶å: $original_name"
            echo "è·¯å¾„éƒ¨åˆ†: $url_path"

            # è§£æè·¯å¾„æ®µï¼ˆè·³è¿‡åè®®å’ŒåŸŸåéƒ¨åˆ†ï¼‰
            path_parts=($(echo "$url_path" | awk -F/ '{for(i=4;i<=NF;i++) print $i}'))
            echo "æœ‰æ•ˆè·¯å¾„æ®µ: ${path_parts[*]}"

            # ç”Ÿæˆç‰¹å¾ç 
            if [ ${#path_parts[@]} -ge ${{ env.PATH_SEGMENTS }} ]; then
              start_idx=$((${#path_parts[@]} - ${{ env.PATH_SEGMENTS }}))
              signature=$(IFS=_ ; echo "${path_parts[*]:$start_idx:${{ env.PATH_SEGMENTS }}}")
            else
              signature="${path_parts[-1]:-none}"
            fi
            echo "ç”Ÿæˆç­¾å: $signature"

            # æ„å»ºå®‰å…¨æ–‡ä»¶å
            safe_name="${signature}_${original_name}"
            safe_name="${safe_name//[^a-zA-Z0-9_.-]/_}"
            echo "æœ€ç»ˆæ–‡ä»¶å: $safe_name"

            output_path="${{ env.TARGET_BASE_DIR }}/$safe_name"
            echo "::endgroup::"

            # æ‰§è¡Œä¸‹è½½
            echo "ğŸ”„ æ­£åœ¨ä¸‹è½½ (#$total): $safe_name"
            if curl -fLSs --retry 2 "$url" -o "$output_path"; then
              ((success++))
              echo "âœ… ä¸‹è½½æˆåŠŸ: $output_path"
            else
              ((failure++))
              echo "::error::âŒ ä¸‹è½½å¤±è´¥: $url"
              echo "å¤±è´¥URL: $url" >> error.log
              exit 1
            fi
          done < "${{ env.URL_LIST_FILE }}"

          echo "::group::ğŸ“Š æ‰§è¡Œç»Ÿè®¡"
          echo "æ€»å¤„ç†æ•°: $total"
          echo "æˆåŠŸæ•°: $success"
          echo "å¤±è´¥æ•°: $failure"
          echo "::endgroup::"

      - name: Commit changes
        if: success()
        run: |
          git config --global user.name "Auto Sync Bot"
          git config --global user.email "auto-sync@github"
          
          changed_files=$(git status --porcelain "${{ env.TARGET_BASE_DIR }}" | wc -l)
          if [ "$changed_files" -gt 0 ]; then
            git add "${{ env.TARGET_BASE_DIR }}"
            git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥: æ›´æ–° $changed_files ä¸ªæ–‡ä»¶"
            git push
            echo "::notice::å·²æäº¤ $changed_files ä¸ªæ–‡ä»¶å˜æ›´"
          else
            echo "::notice::æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-debug-logs
          path: |
            error.log
            ${{ env.TARGET_BASE_DIR }}/
          retention-days: 3

  report:
    needs: [file-sync]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Show final report
        run: |
          echo "::group::ğŸ“œ æœ€ç»ˆæŠ¥å‘Š"
          echo "åŒæ­¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "ç›®æ ‡ç›®å½•: ${{ env.TARGET_BASE_DIR }}"
          echo "åŸå§‹ä»“åº“: ${{ github.repository }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "::endgroup::"
          
          if [[ "${{ needs.file-sync.result }}" == "success" ]]; then
            echo "::notice::âœ… åŒæ­¥æµç¨‹å®Œæˆ"
          else
            echo "::error::âŒ åŒæ­¥æµç¨‹å¤±è´¥"
            echo "è¯·ä¸‹è½½ debug-logs äº§ç‰©æŸ¥çœ‹è¯¦æƒ…"
          fi
