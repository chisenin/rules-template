name: Smart File Sync with Path Encoding
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

# ================= 用户配置区 =================
env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_BASE_DIR: 'rules'
  PATH_SEGMENTS: 2
# ==============================================

permissions:
  contents: write

jobs:
  file-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          mkdir -p "${{ env.TARGET_BASE_DIR }}"
          rm -rf ./sync-logs && mkdir ./sync-logs

      - name: Download files
        run: |
          while IFS= read -r raw_url; do
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && continue
            
            url="${raw_url%%[#?]*}"
            path_parts=($(echo "$url" | awk -F/ '{for(i=1;i<=NF;i++) if($i!="") print $i}'))
            
            if [ ${#path_parts[@]} -ge ${{ env.PATH_SEGMENTS }} ]; then
              start_idx=$(( ${#path_parts[@]} - ${{ env.PATH_SEGMENTS }} ))
              signature=$(IFS=_ ; echo "${path_parts[*]:$start_idx:${{ env.PATH_SEGMENTS }}}")
            else
              signature="${path_parts[-1]}"
            fi

            original_name="${url##*/}"
            safe_name="${signature}_${original_name}"
            safe_name="${safe_name//[^a-zA-Z0-9_.-]/_}"
            
            output_path="${{ env.TARGET_BASE_DIR }}/$safe_name"
            echo "下载: $url → $output_path"
            
            if curl -fL "$url" -o "$output_path"; then
              echo "[SUCCESS] $(date +%FT%T) $url" >> ./sync-logs/success.log
            else
              echo "[FAILED] $(date +%FT%T) $url" >> ./sync-logs/error.log
              exit 1
            fi
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit changes
        if: success()
        run: |
          git config --global user.name "Auto Syncer"
          git config --global user.email "auto-sync@github"
          
          git add "${{ env.TARGET_BASE_DIR }}"
          if ! git diff --quiet --exit-code; then
            git commit -m " Synced files: $(date +%F)"
            git push
          fi

      - name: Upload logs (v4)
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: |
            ./sync-logs/*
          retention-days: 7

  status-notify:
    needs: [file-sync]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions-cool/workflow-status@v1
        with:
          check: ${{ needs.file-sync.result }}
          success: '✅ 同步完成至目录: ${{ env.TARGET_BASE_DIR }}'
          failure: '❌ 同步失败，查看Artifact日志'
