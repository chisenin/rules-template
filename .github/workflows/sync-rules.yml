name: Auto File Sync with Path Encoding
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

# ================= ç”¨æˆ·é…ç½®åŒº =================
env:
  URL_LIST_FILE: 'rules-list.txt'     # URLåˆ—è¡¨æ–‡ä»¶è·¯å¾„
  TARGET_BASE_DIR: 'rules'   # å­˜å‚¨ç›®å½•
  PATH_SEGMENTS: 2                 # è·¯å¾„ç‰¹å¾ç æ·±åº¦
# ==============================================

permissions:
  contents: write

jobs:
  file-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare workspace
        run: |
          mkdir -p "${{ env.TARGET_BASE_DIR }}"
          rm -rf ./sync-logs && mkdir ./sync-logs

      - name: Process URLs
        run: |
          while IFS= read -r raw_url; do
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && continue
            
            # æ¸…æ´—URLå¹¶åˆ†å‰²è·¯å¾„
            url="${raw_url%%[#?]*}"
            path_parts=($(echo "$url" | awk -F/ '{for(i=1;i<=NF;i++) if($i!="") print $i}'))
            
            # ç”Ÿæˆè·¯å¾„ç‰¹å¾ç 
            if [ ${#path_parts[@]} -ge ${{ env.PATH_SEGMENTS }} ]; then
              start_idx=$(( ${#path_parts[@]} - ${{ env.PATH_SEGMENTS }} ))
              signature=$(IFS=_ ; echo "${path_parts[*]:$start_idx:${{ env.PATH_SEGMENTS }}}")
            else
              signature="${path_parts[-1]}"
            fi

            # æ„å»ºå®‰å…¨æ–‡ä»¶å
            original_name="${url##*/}"
            safe_name="${signature}_${original_name}"
            safe_name="${safe_name//[^a-zA-Z0-9_.-]/_}"
            
            # ä¸‹è½½æ–‡ä»¶
            output_path="${{ env.TARGET_BASE_DIR }}/$safe_name"
            echo "â–¶ï¸ æ­£åœ¨åŒæ­¥: $url â†’ $output_path"
            
            if curl -fsSL "$url" -o "$output_path"; then
              echo "[SUCCESS] $(date +%FT%T) $url" >> ./sync-logs/success.log
            else
              echo "[FAILED]  $(date +%FT%T) $url" >> ./sync-logs/error.log
              exit 1
            fi
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit changes
        if: success()
        run: |
          git config --global user.name "GitHub Auto Sync"
          git config --global user.email "auto-sync@github.com"
          
          git add "${{ env.TARGET_BASE_DIR }}"
          if ! git diff --quiet --exit-code; then
            git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ–‡ä»¶ [$(date +%F)]" -m "æ¥æº: ${{ env.URL_LIST_FILE }}"
            git push
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: ./sync-logs/
          retention-days: 3

  status-report:
    needs: [file-sync]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Show report
        run: |
          echo "::group::ğŸ“‹ åŒæ­¥æ‰§è¡ŒæŠ¥å‘Š"
          echo "æ‰§è¡Œæ—¶é—´: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "ç›®æ ‡ç›®å½•: ${{ env.TARGET_BASE_DIR }}"
          echo "å¤„ç†ç»“æœ: ${{ needs.file-sync.result }}"
          echo "::endgroup::"
          
          if [[ "${{ needs.file-sync.result }}" == "success" ]]; then
            echo "::notice::âœ… å·²æˆåŠŸåŒæ­¥æ–‡ä»¶åˆ°ç›®å½•: ${{ env.TARGET_BASE_DIR }}"
          else
            echo "::error::âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·ä¸‹è½½ Artifact æ—¥å¿—æ’æŸ¥é—®é¢˜"
          fi
