name: Verified Rules Sync
on:
  workflow_dispatch:
  push:
    paths:
      - 'rules-list.txt'
  schedule:
    - cron: '0 4 * * *'

env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_DIR: 'rules'
  PATH_SEGMENTS: 2

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0

      - name: Setup directories
        run: |
          # åˆ›å»ºç²¾ç¡®çš„ç›®æ ‡ç›®å½•
          mkdir -p "./repo/${{ env.TARGET_DIR }}"
          echo "éªŒè¯ç›®å½•ç»“æ„ï¼š"
          ls -l ./repo

      - name: Process URLs (Debug Mode)
        working-directory: ./repo
        run: |
          set -x  # å¯ç”¨è°ƒè¯•æ¨¡å¼
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®æ ‡ç›®å½•ç»å¯¹è·¯å¾„: $(realpath ${{ env.TARGET_DIR }})"

          while IFS= read -r raw_url; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ "$raw_url" =\~ ^#.*$ || -z "$raw_url" ]] && continue

            # æ¸…æ´—URL
            clean_url=$(echo "$raw_url" | awk '{print $1}' | xargs)

            # ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
            url_path="${clean_url%/*}"
            path_parts=($(echo "$url_path" | awk -F/ '{for(i=4;i<=NF;i++) print $i}'))
            signature=$(IFS=_ ; echo "${path_parts[*]: -2}")
            safe_name="${signature}_${clean_url##*/}"
            safe_name=$(echo "$safe_name" | tr -cd 'a-zA-Z0-9_.-')

            # å®Œæ•´è¾“å‡ºè·¯å¾„
            output_path="${{ env.TARGET_DIR }}/$safe_name"
            echo "ä¸‹è½½è·¯å¾„éªŒè¯: $(pwd)/$output_path"

            # å¸¦é‡è¯•çš„ä¸‹è½½
            if curl --retry 3 --retry-delay 5 -fL "$clean_url" -o "$output_path"; then
              echo "âœ… æ–‡ä»¶å·²ä¿å­˜åˆ°: $output_path"
              ls -l "$output_path"
            else
              echo "::error::ä¸‹è½½å¤±è´¥: $clean_url"
              exit 1
            fi
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit changes
        working-directory: ./repo
        run: |
          # æäº¤å‰éªŒè¯
          echo "=== å¾…æäº¤æ–‡ä»¶ ==="
          git status --porcelain
          
          if [ -n "$(git status --porcelain)" ]; then
            git config --global user.name "Auto Sync Bot"
            git config --global user.email "bot@sync"
            git add "${{ env.TARGET_DIR }}"
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°è§„åˆ™æ–‡ä»¶"
            git push
          fi
