name: Regex-Fixed Rules Sync
on:
  workflow_dispatch:
  push:
    paths:
      - 'rules-list.txt'
  schedule:
    - cron: '0 4 * * *'

env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_DIR: 'rules'
  PATH_SEGMENTS: 2

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: repo

      - name: Process URLs
        working-directory: ./repo
        run: |
          # 修复的正则表达式语法
          while IFS= read -r raw_url || [[ -n "$raw_url" ]]; do
            # 使用兼容性更好的条件判断
            if [[ "$raw_url" =\~ ^#.*$ || -z "${raw_url// }" ]]; then
              echo "跳过注释/空行: ${raw_url:0:20}..."
              continue
            fi

            # URL清洗（兼容特殊字符）
            clean_url=$(echo "$raw_url" | awk '{sub(/^[ \t]+/, ""); sub(/[ \t]+$/, ""); print}')
            
            # 路径处理逻辑...
            output_path="${{ env.TARGET_DIR }}/$safe_name"
            
            curl --retry 3 -fL "$clean_url" -o "$output_path"
          done < "${{ env.URL_LIST_FILE }}"
