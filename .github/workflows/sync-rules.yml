name: Path-Fixed Rules Sync
on:
  workflow_dispatch:
  push:
    paths:
      - 'rules-list.txt'
  schedule:
    - cron: '0 4 * * *'

env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_DIR: 'rules'
  PATH_SEGMENTS: 2

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Setup directories
        run: |
          # åˆ›å»ºç›¸å¯¹è·¯å¾„ç›®å½•
          mkdir -p "./repo/${{ env.TARGET_DIR }}"
          echo "éªŒè¯ç›®å½•ç»“æ„ï¼š"
          tree -d ./repo

      - name: Process URLs
        working-directory: ./repo  # ä½¿ç”¨ç›¸å¯¹è·¯å¾„
        run: |
          set -x
          while IFS= read -r raw_url; do
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && continue

            # æ–‡ä»¶åç”Ÿæˆé€»è¾‘...
            output_path="${{ env.TARGET_DIR }}/$safe_name"
            
            # å¸¦è·¯å¾„éªŒè¯çš„ä¸‹è½½
            echo "ç»å¯¹è·¯å¾„ï¼š$(pwd)/$output_path"
            curl -fL "$clean_url" -o "$output_path"
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit changes
        working-directory: ./repo
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          git add "${{ env.TARGET_DIR }}"
          git commit -m "ğŸ”„ æ›´æ–°è§„åˆ™æ–‡ä»¶"
          git push
