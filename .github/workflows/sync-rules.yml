name: Final Rules Sync Solution
on:
  workflow_dispatch:
  push:
    paths:
      - 'rules-list.txt'
  schedule:
    - cron: '0 4 * * *'

env:
  URL_LIST_FILE: 'rules-list.txt'
  TARGET_DIR: 'rules'
  PATH_SEGMENTS: 2

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Initialize directories
        run: |
          # åˆ›å»ºå¤šçº§ç›®å½•ç»“æ„
          mkdir -p "$GITHUB_WORKSPACE/repo/${{ env.TARGET_DIR }}"
          echo "ç›®æ ‡ç›®å½•è·¯å¾„ï¼š$GITHUB_WORKSPACE/repo/${{ env.TARGET_DIR }}"

      - name: Sync files
        working-directory: $GITHUB_WORKSPACE/repo
        run: |
          # è°ƒè¯•æ¨¡å¼
          set -x

          # å®‰å…¨åˆå§‹åŒ–å˜é‡
          error_log="sync_errors.log"
          total_count=0
          success_count=0
          failure_count=0

          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "${{ env.URL_LIST_FILE }}" ]; then
            echo "::error::URLåˆ—è¡¨æ–‡ä»¶ä¸å­˜åœ¨: ${{ env.URL_LIST_FILE }}"
            exit 1
          fi

          # ä¸»å¤„ç†å¾ªç¯
          while IFS= read -r raw_url || [ -n "$raw_url" ]; do
            ((total_count++))
            
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ "$raw_url" =\~ ^[[:space:]]*$ || "$raw_url" == \#* ]] && continue

            # URLé¢„å¤„ç†
            clean_url=$(echo "$raw_url" | awk '{print $1}' | sed 's/[[:space:]]*$//')
            echo "å¤„ç†URL: $clean_url"

            # éªŒè¯URLæ ¼å¼
            if [[ ! "$clean_url" =\~ ^https?:// ]]; then
              echo "::warning::æ— æ•ˆåè®®: $clean_url"
              ((failure_count++))
              continue
            fi

            # æ–‡ä»¶åç”Ÿæˆ
            url_path="${clean_url%/*}"
            filename="${clean_url##*/}"
            path_parts=($(echo "$url_path" | awk -F/ '{for(i=4;i<=NF;i++) print $i}'))
            
            if [ ${#path_parts[@]} -ge ${{ env.PATH_SEGMENTS }} ]; then
              signature=$(IFS=_ ; echo "${path_parts[*]: -${{ env.PATH_SEGMENTS }}}")
            else
              signature="${path_parts[-1]:-default}"
            fi

            safe_name="${signature}_${filename}"
            safe_name=$(echo "$safe_name" | tr -cd 'a-zA-Z0-9_.-')
            output_path="${{ env.TARGET_DIR }}/$safe_name"

            # ä¸‹è½½æ‰§è¡Œ
            echo "ä¸‹è½½åˆ°: $(pwd)/$output_path"
            if curl --retry 3 --retry-delay 5 -fL "$clean_url" -o "$output_path"; then
              ((success_count++))
              echo "âœ… ä¸‹è½½æˆåŠŸ"
            else
              echo "::error::ä¸‹è½½å¤±è´¥"
              ((failure_count++))
              # æ¸…ç†æ®‹ç•™æ–‡ä»¶
              [ -f "$output_path" ] && rm -f "$output_path"
            fi
          done < "${{ env.URL_LIST_FILE }}"

          # ç»“æœç»Ÿè®¡
          echo "total=$total_count" >> $GITHUB_OUTPUT
          echo "success=$success_count" >> $GITHUB_OUTPUT
          echo "failure=$failure_count" >> $GITHUB_OUTPUT

          if [ $failure_count -gt 0 ]; then
            echo "::warning::åŒæ­¥å®Œæˆï¼Œå¤±è´¥é¡¹ï¼š$failure_count"
            exit 1
          fi

      - name: Verify files
        working-directory: $GITHUB_WORKSPACE/repo
        run: |
          echo "=== æ–‡ä»¶éªŒè¯ ==="
          ls -l "${{ env.TARGET_DIR }}"
          [ "$(ls -A "${{ env.TARGET_DIR }}")" ] || echo "ç›®å½•ä¸ºç©º"

      - name: Commit changes
        working-directory: $GITHUB_WORKSPACE/repo
        if: success() || failure()
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add "${{ env.TARGET_DIR }}"
            git commit -m "ğŸ”„ åŒæ­¥æ›´æ–°ï¼šæˆåŠŸ ${{ steps.sync-rules.outputs.success }} é¡¹"
            git push
          else
            echo "æ— å˜æ›´éœ€è¦æäº¤"
          fi
