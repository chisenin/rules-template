name: Rules Auto Sync
on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'rules-list.txt'  # æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘
  schedule:
    - cron: '0 4 * * *'  # æ¯å¤©UTC 4ç‚¹æ‰§è¡Œ

env:
  URL_LIST_FILE: 'rules-list.txt'  # æ–°ç‰ˆåˆ—è¡¨æ–‡ä»¶
  TARGET_DIR: 'rules'              # è¾“å‡ºç›®å½•
  PATH_SEGMENTS: 2                # è·¯å¾„ç‰¹å¾ç æ·±åº¦

permissions:
  contents: write  # å¿…é¡»çš„å†™å…¥æƒé™

jobs:
  sync-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Create rules directory
        run: |
          mkdir -p "${{ env.TARGET_DIR }}"
          echo "ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆï¼š"
          ls -lhd "${{ env.TARGET_DIR }}"

      - name: Process rules list
        run: |
          echo "=== å¼€å§‹å¤„ç†è§„åˆ™åˆ—è¡¨ ==="
          echo "å½“å‰æ—¶é—´: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "å¾…å¤„ç†æ–‡ä»¶æ•°é‡: $(grep -vE '^#|^$' ${{ env.URL_LIST_FILE }} | wc -l)"

          while IFS= read -r raw_url; do
            [[ -z "$raw_url" || "$raw_url" == \#* ]] && continue

            # è·¯å¾„ç‰¹å¾ç ç”Ÿæˆ
            clean_url="${raw_url%%[#?]*}"
            url_path="${clean_url%/*}"
            path_parts=($(echo "$url_path" | awk -F/ '{for(i=4;i<=NF;i++) print $i}'))
            
            # åŠ¨æ€æ–‡ä»¶åç”Ÿæˆ
            if [ ${#path_parts[@]} -ge ${{ env.PATH_SEGMENTS }} ]; then
              start_idx=$(( ${#path_parts[@]} - ${{ env.PATH_SEGMENTS }} ))
              signature=$(IFS=_ ; echo "${path_parts[*]:$start_idx:${{ env.PATH_SEGMENTS }}}")
            else
              signature="${path_parts[-1]}"
            fi

            final_name="${signature}_${clean_url##*/}"
            final_name="${final_name//[^a-zA-Z0-9_.-]/_}"
            output_path="${{ env.TARGET_DIR }}/$final_name"

            # å¸¦é‡è¯•æœºåˆ¶çš„ä¸‹è½½
            echo "ä¸‹è½½: $clean_url â†’ $output_path"
            if curl --retry 3 --retry-delay 5 -fL "$clean_url" -o "$output_path"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ"
            else
              echo "::error::ä¸‹è½½å¤±è´¥: $clean_url"
              exit 1
            fi
          done < "${{ env.URL_LIST_FILE }}"

      - name: Commit updates
        if: success()
        run: |
          git config --global user.name "Rules Sync Bot"
          git config --global user.email "bot@rules.sync"

          if git diff --quiet --exit-code; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            git add "${{ env.TARGET_DIR }}"
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°è§„åˆ™æ–‡ä»¶ [$(date +%F)]"
            git push
            echo "å·²æäº¤æ–°ç‰ˆæœ¬è§„åˆ™æ–‡ä»¶"
          fi

      - name: Post-cleanup
        if: always()
        run: |
          echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
          rm -f tmp_download.*
          echo "å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"

  health-check:
    needs: sync-rules
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Final report
        run: |
          echo "æœ€ååŒæ­¥æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ç›®æ ‡ç›®å½•: ${{ env.TARGET_DIR }}"
          echo "åŒæ­¥ç»“æœ: ${{ needs.sync-rules.result }}"
          echo "è¯¦æƒ…æŸ¥çœ‹: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
